# IntÃ©gration Supabase - Guide Complet

## ğŸ”§ Setup Initial

### 1. CrÃ©er un compte Supabase

1. Allez sur [supabase.com](https://supabase.com)
2. Cliquez sur "Start your project"
3. Connectez-vous avec GitHub ou votre email
4. CrÃ©ez une nouvelle organisation et un projet

### 2. Obtenir vos clÃ©s d'API

1. Dans votre projet, allez Ã  "Settings" â†’ "API"
2. Copiez :
   - **Project URL** : `https://your-project.supabase.co`
   - **anon public** : ClÃ© publique (safe to expose)
   - **service_role** : ClÃ© secrÃ¨te (ne pas exposer)

### 3. Configurer les variables d'environnement

CrÃ©ez `.env.local` Ã  la racine du projet :

```env
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-public-anon-key
```

## ğŸ“Š CrÃ©er une Table de Test

### SQL de crÃ©ation

```sql
-- Table de ventes
CREATE TABLE public.sales (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  date DATE NOT NULL,
  region TEXT NOT NULL,
  amount DECIMAL(10, 2) NOT NULL,
  customers BIGINT NOT NULL,
  products BIGINT NOT NULL,
  satisfaction DECIMAL(3, 1),
  created_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT positive_amount CHECK (amount > 0),
  CONSTRAINT valid_customers CHECK (customers >= 0)
);

-- CrÃ©er un index pour les performances
CREATE INDEX sales_date_idx ON sales(date);
CREATE INDEX sales_region_idx ON sales(region);

-- Ajouter une politique RLS (Row Level Security)
ALTER TABLE public.sales ENABLE ROW LEVEL SECURITY;

-- Permettre la lecture publique
CREATE POLICY "Enable read access for all users" 
ON public.sales FOR SELECT 
USING (true);
```

### Via l'interface Supabase

1. Allez dans "SQL Editor"
2. Cliquez sur "New Query"
3. Collez le SQL ci-dessus
4. Cliquez "Run"

## âœ… IntÃ©grer Supabase dans l'App

### 1. Modifier le hook useDataSource

```typescript
// src/hooks/useDataSource.ts
import { supabase } from '@/lib/supabase'

export function useDataSource() {
  // ... existing code ...

  const loadFromSupabase = useCallback(
    async (table: string) => {
      setLoading(true)
      try {
        const { data, error } = await supabase
          .from(table)
          .select('*')

        if (error) throw error

        const columns = data.length > 0 ? Object.keys(data[0]) : []
        const source: DataSource = {
          id: `supabase-${table}-${Date.now()}`,
          name: table,
          type: 'supabase',
          data: data as DataPoint[],
          columns,
          uploadedAt: new Date(),
        }

        setDataSources(prev => [...prev, source])
      } catch (err) {
        setError(err instanceof Error ? err.message : 'Erreur Supabase')
      } finally {
        setLoading(false)
      }
    },
    []
  )

  return { ..., loadFromSupabase }
}
```

### 2. CrÃ©er un client Supabase

```typescript
// src/lib/supabase.ts
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!

export const supabase = createClient(supabaseUrl, supabaseAnonKey)
```

### 3. Modifier SupabaseConfig

```typescript
// src/components/SupabaseConfig.tsx
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault()
  
  try {
    const { data, error } = await supabase
      .from(config.table)
      .select('*')
      .limit(1)

    if (error) throw error

    setConnected(true)
    onConnect?.(config)
  } catch (err) {
    setError(err instanceof Error ? err.message : 'Connexion Ã©chouÃ©e')
  }
}
```

## ğŸ”’ SÃ©curitÃ© - Row Level Security (RLS)

### Activer RLS

```sql
-- Activer RLS sur la table
ALTER TABLE public.sales ENABLE ROW LEVEL SECURITY;

-- Politique de lecture publique
CREATE POLICY "Enable read access"
ON public.sales
FOR SELECT
USING (true);

-- Politique d'insertion (authentifiÃ©s seulement)
CREATE POLICY "Enable insert for authenticated users"
ON public.sales
FOR INSERT
WITH CHECK (auth.role() = 'authenticated');

-- Politique de suppression (propriÃ©taire seulement)
CREATE POLICY "Enable delete for users based on user_id"
ON public.sales
FOR DELETE
USING (auth.uid() = user_id);
```

### Authentification

```typescript
// S'authentifier
const { data, error } = await supabase.auth.signInWithPassword({
  email: 'user@example.com',
  password: 'password',
})

// S'inscrire
const { data, error } = await supabase.auth.signUp({
  email: 'user@example.com',
  password: 'password',
})

// VÃ©rifier la session
const { data: { user } } = await supabase.auth.getUser()
```

## ğŸ“ˆ RequÃªtes AvancÃ©es

### Filtrer les donnÃ©es

```typescript
// Simple
const { data } = await supabase
  .from('sales')
  .select('*')
  .eq('region', 'Nord')

// Multiple conditions
const { data } = await supabase
  .from('sales')
  .select('*')
  .eq('region', 'Nord')
  .gte('amount', 1000)

// IN clause
const { data } = await supabase
  .from('sales')
  .select('*')
  .in('region', ['Nord', 'Sud'])
```

### AgrÃ©gations

```typescript
// Count
const { count } = await supabase
  .from('sales')
  .select('*', { count: 'exact' })

// Sum/Avg (avec postgres functions)
const { data } = await supabase
  .rpc('get_total_sales', { region: 'Nord' })
```

### RequÃªte brute avec RPC

```sql
-- Fonction SQL personnalisÃ©e
CREATE OR REPLACE FUNCTION get_total_sales(region_name TEXT)
RETURNS BIGINT AS $$
  SELECT SUM(amount)::BIGINT FROM sales WHERE region = region_name
$$ LANGUAGE SQL;
```

```typescript
// Appel
const { data } = await supabase
  .rpc('get_total_sales', { region_name: 'Nord' })
```

## âš¡ Ã‰couter les Changements en Temps RÃ©el

```typescript
// S'abonner aux changements
const subscription = supabase
  .channel('public:sales')
  .on(
    'postgres_changes',
    { 
      event: '*', 
      schema: 'public', 
      table: 'sales' 
    },
    (payload) => {
      console.log('Change received!', payload)
      // Mettre Ã  jour l'Ã©tat
    }
  )
  .subscribe()

// Se dÃ©sabonner
subscription.unsubscribe()
```

## ğŸ” Debugging Supabase

### Logs

```typescript
// Activer les logs de debug
import { enableDebugLogging } from '@supabase/supabase-js'
enableDebugLogging(true)
```

### VÃ©rifier la connexion

```typescript
// Tester la connexion
const { data, error } = await supabase
  .from('sales')
  .select('*')
  .limit(1)

if (error) {
  console.error('Erreur Supabase:', error)
} else {
  console.log('Connexion OK:', data)
}
```

## ğŸš€ Best Practices

### 1. RÃ©utiliser l'instance Supabase

```typescript
// âœ… BON
export const supabase = createClient(url, key)

// âŒ MAUVAIS (crÃ©e une nouvelle instance Ã  chaque fois)
const supabase = createClient(url, key)
```

### 2. GÃ©rer les erreurs

```typescript
try {
  const { data, error } = await supabase
    .from('sales')
    .select('*')

  if (error) throw error
  return data
} catch (error) {
  console.error('Database error:', error)
  // Afficher un message d'erreur Ã  l'utilisateur
}
```

### 3. Limiter les donnÃ©es

```typescript
// Toujours spÃ©cifier .limit() pour les grandes tables
const { data } = await supabase
  .from('sales')
  .select('*')
  .range(0, 99)  // Pagination
```

### 4. Indexer les colonnes frÃ©quemment requÃªtÃ©es

```sql
CREATE INDEX sales_date_region_idx ON sales(date, region);
```

## ğŸ†˜ DÃ©pannage

### "Not Authenticated"
- VÃ©rifier votre clÃ© d'API
- Assurez-vous que RLS est correctement configurÃ©
- VÃ©rifier les politiques d'accÃ¨s

### "Duplicate key error"
- VÃ©rifier les contraintes uniques
- VÃ©rifier si l'enregistrement existe dÃ©jÃ 

### Lenteur des requÃªtes
- Ajouter des index
- Utiliser SELECT avec colonnes spÃ©cifiques (pas *)
- Paginer les rÃ©sultats

### DÃ©passement de limites
- Supabase Free: 500MB de base de donnÃ©es
- Supabase Pro: Utilisation Ã  base de calcul
- Consulter la documentation tarifaire

## ğŸ“š Ressources Externes

- [Supabase Documentation](https://supabase.com/docs)
- [Supabase JS Client](https://supabase.com/docs/reference/javascript)
- [PostgreSQL Guide](https://www.postgresql.org/docs)
- [Supabase Community](https://discord.supabase.com)

---

PrÃªt Ã  utiliser Supabase ! ğŸš€
